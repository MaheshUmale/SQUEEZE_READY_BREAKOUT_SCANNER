<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Squeeze Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #111827; color: white; }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
            padding: 16px;
        }
        .cell {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            height: 110px;
            transition: transform 0.2s, background-color 0.2s;
            border: 1px solid #374151;
        }
        .cell:hover {
            transform: scale(1.05);
            border-color: #9ca3af;
        }
        .stock-logo {
            width: 36px;
            height: 36px;
            margin-bottom: 6px;
            border-radius: 50%;
            background-color: #374151;
        }
        .stock-ticker {
            font-weight: 600;
            font-size: 14px;
        }
        .stock-info {
            font-size: 11px;
            color: #d1d5db;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-6">Stocks Currently in a Squeeze</h1>
        <div id="chart" class="chart-container"></div>
        <div class="tooltip"></div>
    </div>

    <script>
        const chartContainer = d3.select("#chart");
        const tooltip = d3.select(".tooltip");

        async function loadData() {
            try {
                const data = await d3.json(`treemap_data.json?t=${new Date().getTime()}`);

                // Sort data by HeatmapScore (value)
                data.sort((a, b) => b.value - a.value);

                // Define a single color scale based on RVOL
                // Using a green scale, as "in a squeeze" is a state of interest
                const colorScale = d3.scaleLinear()
                    .domain([0, 5]) // RVOL typically ranges from 0 to 5+
                    .range(["#166534", "#22c55e"]) // Dark green to bright green
                    .clamp(true);

                // --- D3 Data Binding ---
                const cells = chartContainer.selectAll(".cell")
                    .data(data, d => d.name);

                // Exit selection
                cells.exit().remove();

                // Enter selection
                const enterCells = cells.enter()
                    .append("div")
                    .attr("class", "cell")
                    .on("click", (event, d) => window.open(d.url, "_blank"))
                    .on("mouseover", function(event, d) {
                        tooltip.transition().duration(200).style("opacity", .9);
                        tooltip.html(
                            `<strong>${d.name.replace('NSE:', '')}</strong><br/>` +
                            `Squeeze on ${d.count} timeframes<br/>` +
                            `RVOL: ${d.rvol.toFixed(2)}<br/>` +
                            `Score: ${d.value.toFixed(2)}`
                        )
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition().duration(500).style("opacity", 0);
                    });

                enterCells.append("img").attr("class", "stock-logo");
                enterCells.append("div").attr("class", "stock-ticker");
                enterCells.append("div").attr("class", "stock-info");

                // Merge enter and update selections
                const updateCells = enterCells.merge(cells);

                // Update all cells
                updateCells.style("background-color", d => colorScale(d.rvol));

                updateCells.select(".stock-logo")
                    .attr("src", d => d.logo)
                    .style("display", d => d.logo ? 'block' : 'none');

                updateCells.select(".stock-ticker").text(d => d.name.replace('NSE:', ''));
                updateCells.select(".stock-info").text(d => `RVOL: ${d.rvol.toFixed(2)}`);

            } catch (error) {
                console.error("Failed to load or process data:", error);
                chartContainer.html("<p class='text-center text-red-500'>Failed to load data. Please check the console.</p>");
            }
        }

        // Initial data load and interval
        loadData();
        setInterval(loadData, 120000);
    </script>
</body>
</html>