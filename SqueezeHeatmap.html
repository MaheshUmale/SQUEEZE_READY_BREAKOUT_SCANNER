<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Squeeze Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #111827; color: white; }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
            padding: 16px;
        }
        .cell {
            display: flex;
            flex-direction: column;

            justify-content: space-between;
 
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;

            height: 110px;
            transition: transform 0.2s, background-color 0.2s;
            border: 1px solid #374151;

        }
        .stock-logo {
            width: 32px; /* Set a fixed width */
            height: 32px; /* Set a fixed height */
            margin-bottom: 5px; /* Space between logo and ticker */
        }
        .cell:hover {
            transform: scale(1.05);
            border-color: #9ca3af;
        }
        .stock-logo {
            width: 36px;
            height: 36px;
            margin-bottom: 6px;
            border-radius: 50%;
            background-color: #374151;
        }
        .stock-ticker {
            font-weight: 600;
            font-size: 14px;
        }
        .stock-info {
            font-size: 11px;
            color: #d1d5db;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-2">Real-Time Stock Squeeze Scanner</h1>
        <div id="toggle-controls" class="flex justify-center my-4 space-x-2">
            <button id="btn-fired" class="px-4 py-2 rounded-md text-sm font-medium transition">Squeeze Fired</button>
            <button id="btn-in-squeeze" class="px-4 py-2 rounded-md text-sm font-medium transition">In Squeeze</button>
        </div>
        <p id="description" class="text-center text-gray-400 mb-6"></p>
        <div id="chart" class="chart-container"></div>
        <div class="tooltip"></div>
    </div>

    <script>
        const chartContainer = d3.select("#chart");
        const tooltip = d3.select(".tooltip");
        const btnFired = document.getElementById('btn-fired');
        const btnInSqueeze = document.getElementById('btn-in-squeeze');
        const description = document.getElementById('description');

        let currentMode = 'fired'; // 'fired' or 'in_squeeze'
        let refreshInterval;

        // --- Color Scales ---
        const rvolDomain = [0, 5];
        const bullishColor = d3.scaleLinear().domain(rvolDomain).range(["#064e3b", "#10b981"]).clamp(true);
        const bearishColor = d3.scaleLinear().domain(rvolDomain).range(["#7f1d1d", "#ef4444"]).clamp(true);
        const neutralColor = d3.scaleLinear().domain(rvolDomain).range(["#374151", "#6b7280"]).clamp(true);
        const inSqueezeColor = d3.scaleLinear().domain(rvolDomain).range(["#166534", "#22c55e"]).clamp(true);

        function getCellColor(d) {
            if (currentMode === 'fired') {
                if (d.momentum === 'Bullish') return bullishColor(d.rvol);
                if (d.momentum === 'Bearish') return bearishColor(d.rvol);
                return neutralColor(d.rvol);
            }
            return inSqueezeColor(d.rvol);
        }

        function getTooltipHtml(d) {
            if (currentMode === 'fired') {
                return `<strong>${d.name.replace('NSE:', '')}</strong><br/>` +
                       `Momentum: <span style="color: ${getCellColor(d)};">${d.momentum}</span><br/>` +
                       `RVOL: ${d.rvol.toFixed(2)}<br/>` +
                       `Score: ${d.value.toFixed(2)}`;
            }
            return `<strong>${d.name.replace('NSE:', '')}</strong><br/>` +
                   `Squeeze on ${d.count} timeframes<br/>` +
                   `RVOL: ${d.rvol.toFixed(2)}<br/>` +
                   `Score: ${d.value.toFixed(2)}`;
        }

        async function loadData() {
            const filename = currentMode === 'fired' ? 'treemap_data_fired.json' : 'treemap_data_in_squeeze.json';
            try {
                const data = await d3.json(`${filename}?t=${new Date().getTime()}`);
                data.sort((a, b) => b.value - a.value);

                // --- D3 Data Binding ---
                const cells = chartContainer.selectAll(".cell")
                    .data(data, d => d.name);

                cells.exit().remove();

                const enterCells = cells.enter()
                    .append("div")
                    .attr("class", "cell")
                    .on("click", (event, d) => window.open(d.url, "_blank"))
                    .on("mouseover", function(event, d) {
                        tooltip.transition().duration(200).style("opacity", .9);
                        tooltip.html(getTooltipHtml(d))
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition().duration(500).style("opacity", 0);
                    });

                enterCells.append("img").attr("class", "stock-logo");
                enterCells.append("div").attr("class", "stock-ticker");
                enterCells.append("div").attr("class", "stock-info");

                const updateCells = enterCells.merge(cells);

                updateCells.style("background-color", d => getCellColor(d));
                updateCells.select(".stock-logo").attr("src", d => d.logo).style("display", d => d.logo ? 'block' : 'none');
                updateCells.select(".stock-ticker").text(d => d.name.replace('NSE:', ''));
                updateCells.select(".stock-info").text(d => `RVOL: ${d.rvol.toFixed(2)}`);

            } catch (error) {
                console.error(`Failed to load data from ${filename}:`, error);
                chartContainer.html(`<p class='text-center text-red-500'>Could not load heatmap data. Is the Python scanner running?</p>`);
            }
        }

        function setMode(mode) {
            currentMode = mode;

            if (mode === 'fired') {
                btnFired.classList.add('bg-blue-600', 'text-white');
                btnFired.classList.remove('bg-gray-700', 'text-gray-300');
                btnInSqueeze.classList.add('bg-gray-700', 'text-gray-300');
                btnInSqueeze.classList.remove('bg-blue-600', 'text-white');
                description.innerText = 'Heatmap of stocks that have just broken out of a volatility squeeze.';
            } else {
                btnInSqueeze.classList.add('bg-blue-600', 'text-white');
                btnInSqueeze.classList.remove('bg-gray-700', 'text-gray-300');
                btnFired.classList.add('bg-gray-700', 'text-gray-300');
                btnFired.classList.remove('bg-blue-600', 'text-white');
                description.innerText = 'Heatmap of stocks that are currently in a state of low volatility.';
            }
            loadData();
        }

        btnFired.addEventListener('click', () => setMode('fired'));
        btnInSqueeze.addEventListener('click', () => setMode('in_squeeze'));

        // Initial setup
        setMode('fired');
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(loadData, 120000);

    </script>
</body>
</html>