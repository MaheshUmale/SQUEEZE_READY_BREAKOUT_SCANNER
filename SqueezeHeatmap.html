<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Logo Wall</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
        }
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            height: 100px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .cell:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stock-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
        }
        .stock-ticker {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 my-6">Stock Screener</h1>
        <div id="chart" class="chart-container"></div>
    </div>

    <script>
        const chartContainer = d3.select("#chart");

        async function loadData() {
            try {
                // Append a cache-busting query parameter to ensure fresh data
                const data = await d3.json(`treemap_data.json?t=${new Date().getTime()}`);

                // --- D3 Data Binding ---
                const cells = chartContainer.selectAll(".cell")
                    .data(data, d => d.name); // Key function for object constancy

                // Exit selection: Remove cells that are no longer in the data
                cells.exit().remove();

                // Enter selection: Create new div elements for new stocks
                const enterCells = cells.enter()
                    .append("a") // Use an anchor tag to make the whole cell clickable
                    .attr("href", d => d.url)
                    .attr("target", "_blank")
                    .attr("class", "cell");

                // Add child elements for the logo and text within each cell
                enterCells.append("img")
                    .attr("class", "stock-logo")
                    .attr("src", d => d.logo)
                    .style("display", d => d.logo ? 'block' : 'none'); // Hide if no logo

                enterCells.append("div")
                    .attr("class", "stock-ticker");

                // Merge enter and update selections to apply updates to all existing cells
                const updateCells = enterCells.merge(cells);

                // Update content for all cells
                updateCells.select(".stock-logo")
                    .attr("src", d => d.logo)
                    .style("display", d => d.logo ? 'block' : 'none');

                updateCells.select(".stock-ticker")
                    .text(d => d.name.replace('NSE:', ''));

            } catch (error) {
                console.error("Failed to load data:", error);
                chartContainer.html("<p class='text-center text-red-500'>Failed to load data. Please check the console.</p>");
            }
        }

        // Initial data load
        loadData();

        // Set an interval to auto-refresh the data every 2 minutes (120,000 ms)
        setInterval(loadData, 120000);
    </script>
</body>
</html>