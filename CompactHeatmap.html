<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compact Squeeze Heatmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #111827; color: white; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 4px;
        }
        .cell {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            height: 50px;
            transition: transform 0.2s, background-color 0.2s;
            border: 1px solid #374151;
        }
        .cell:hover {
            transform: scale(1.05);
            border-color: #9ca3af;
        }
        .stock-logo {
            width: 20px;
            height: 20px;
            margin-bottom: 2px;
        }
        .stock-ticker {
            font-weight: 500;
            font-size: 10px;
        }
        .squeeze-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 4px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-6">Compact Squeeze Heatmap</h1>
        <div id="heatmap-container"></div>
        <div class="tooltip"></div>
    </div>

    <script>
        const heatmapContainer = d3.select("#heatmap-container");
        const tooltip = d3.select(".tooltip");
        let refreshInterval;

        // --- Color Scales ---
        const rvolDomain = [0, 5];
        const bullishColor = d3.scaleLinear().domain(rvolDomain).range(["#064e3b", "#10b981"]).clamp(true);
        const bearishColor = d3.scaleLinear().domain(rvolDomain).range(["#7f1d1d", "#ef4444"]).clamp(true);
        const neutralColor = d3.scaleLinear().domain(rvolDomain).range(["#374151", "#6b7280"]).clamp(true);

        function getCellColor(d) {
            if (d.momentum === 'Bullish') return bullishColor(d.rvol);
            if (d.momentum === 'Bearish') return bearishColor(d.rvol);
            return neutralColor(d.rvol);
        }

        function getTooltipHtml(d) {
            return `<strong>${d.name.replace('NSE:', '')}</strong><br/>` +
                   `Squeeze on ${d.count} TFs (${d.highest_tf})<br/>` +
                   `Momentum: <span style="color: ${getCellColor(d)};">${d.momentum}</span><br/>` +
                   `RVOL: ${d.rvol.toFixed(2)}`;
        }

        function renderHeatmap(data) {
            heatmapContainer.html(''); // Clear previous content

            if (data.length === 0) {
                heatmapContainer.html("<p class='text-center text-red-500'>No stocks are currently in a squeeze.</p>");
                return;
            }

            const tfOrder = ['Monthly', 'Weekly', '4H', '2H', '1H', '30m', '15m', '5m', '1m', 'Daily', 'Unknown'];

            // Create a single sorted array based on the 2D criteria
            const sortedData = data.sort((a, b) => {
                const tfIndexA = tfOrder.indexOf(a.highest_tf);
                const tfIndexB = tfOrder.indexOf(b.highest_tf);

                if (tfIndexA !== tfIndexB) {
                    return tfIndexA - tfIndexB; // Y-axis sort
                }
                return b.count - a.count; // X-axis sort
            });

            heatmapContainer.classed('grid-container', true); // Make the main container the grid

            const cells = heatmapContainer.selectAll('.cell').data(sortedData, d => d.name);
            cells.exit().remove();

            const enterCells = cells.enter().append("div").attr("class", "cell")
                .on("click", (event, d) => window.open(d.url, "_blank"))
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(getTooltipHtml(d)).style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

            enterCells.append("div").attr("class", "squeeze-badge").text(d => d.count);
            enterCells.append("img").attr("class", "stock-logo");
            enterCells.append("div").attr("class", "stock-ticker");

            const updateCells = enterCells.merge(cells);
            updateCells.style("background-color", d => getCellColor(d));
            updateCells.select(".stock-logo").attr("src", d => d.logo).style("display", d => d.logo ? 'block' : 'none');
            updateCells.select(".stock-ticker").text(d => d.name.replace('NSE:', ''));
        }

        async function loadData() {
            try {
                const inSqueezeData = await d3.json(`treemap_data_in_squeeze.json?t=${new Date().getTime()}`);
                renderHeatmap(inSqueezeData);
            } catch (error) {
                console.error("Failed to load data:", error);
                heatmapContainer.html("<p class='text-center text-red-500'>Could not load 'In Squeeze' data.</p>");
            }
        }

        // Initial data load and interval
        loadData();
        refreshInterval = setInterval(loadData, 120000);

    </script>
</body>
</html>